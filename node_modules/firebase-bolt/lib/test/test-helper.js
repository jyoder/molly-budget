/*
 * Copyright 2015 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var util = require('../util');
var ast = require('../ast');
var logger = require('../logger');
;
/*
 * Run data drive test with tests is one of these formats:
 * [ { label: (opt) <string>, data: <input>, expect: (opt) <expected output> }, ... ]
 * [ [ <input>, <expected output> ], ... ]
 * [ scalar, ... ]
 *
 * Calls testIt(data, expect) for each test.
 */
function dataDrivenTest(tests, testIt, formatter) {
    if (formatter === void 0) { formatter = format; }
    var data;
    var expect;
    var label;
    for (var i = 0; i < tests.length; i++) {
        // Not Array or Object
        if (typeof tests[i] !== 'object') {
            label = formatter(tests[i]);
            data = tests[i];
            expect = undefined;
        }
        else {
            data = tests[i].data;
            if (data === undefined) {
                data = tests[i][0];
            }
            if (data === undefined) {
                data = tests[i];
            }
            if (util.isType(data, 'object') && 'expect' in data) {
                data = util.extend({}, data);
                delete data.expect;
            }
            expect = tests[i].expect || tests[i][1];
            label = tests[i].label;
            if (label === undefined) {
                if (expect !== undefined) {
                    label = formatter(data) + " => " + formatter(expect);
                }
                else {
                    label = formatter(data);
                }
            }
        }
        setup(function () {
            logger.reset();
            logger.silent();
        });
        teardown(function () {
            logger.reset();
        });
        test(label, testIt.bind(undefined, data, expect, tests[i]));
    }
}
exports.dataDrivenTest = dataDrivenTest;
function format(o) {
    switch (util.typeOf(o)) {
        case 'regexp':
            return o.toString();
        default:
            return JSON.stringify(o);
    }
}
function expFormat(x) {
    if (util.isType(x, 'array')) {
        return '[' + x.map(expFormat).join(', ') + ']';
    }
    if (util.isType(x, 'object')) {
        if ('type' in x) {
            return ast.decodeExpression(x);
        }
        var result = '{';
        var sep = '';
        for (var prop in x) {
            if (!x.hasOwnProperty(prop)) {
                continue;
            }
            result += sep + expFormat(x[prop]);
            sep = ', ';
        }
        result += '}';
        return result;
    }
    return JSON.stringify(x);
}
exports.expFormat = expFormat;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdGVzdC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7O0FBRUgsSUFBWSxJQUFJLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDaEMsSUFBWSxHQUFHLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDOUIsSUFBWSxNQUFNLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFNbkMsQ0FBQztBQVlGOzs7Ozs7O0dBT0c7QUFDSCx3QkFBK0IsS0FBYSxFQUFFLE1BQW9CLEVBQUUsU0FBa0I7SUFBbEIseUJBQWtCLEdBQWxCLGtCQUFrQjtJQUNwRixJQUFJLElBQVMsQ0FBQztJQUNkLElBQUksTUFBVyxDQUFDO0lBQ2hCLElBQUksS0FBYSxDQUFDO0lBRWxCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLHNCQUFzQjtRQUN0QixFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixNQUFNLEdBQUcsU0FBUyxDQUFDO1FBQ3JCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3JCLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENB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QkFDNUIsUUFBUSxDQUFDO1lBQ1gsQ0FBQztZQUNELE1BQU0sSUFBSSxHQUFHLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ25DLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDYixDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsQ0FBQztRQUNkLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFyQmUsaUJBQVMsWUFxQnhCLENBQUEiLCJmaWxlIjoidGVzdC90ZXN0LWhlbHBlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxNSBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0ICogYXMgYXN0IGZyb20gJy4uL2FzdCc7XG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuZXhwb3J0IGludGVyZmFjZSBPYmplY3RTcGVjIHtcbiAgbGFiZWw/OiBzdHJpbmc7XG4gIGRhdGE6IGFueTtcbiAgZXhwZWN0PzogYW55O1xufTtcblxuZXhwb3J0IHR5cGUgQXJyYXlTcGVjID0gW2FueSwgYW55XTtcblxuZXhwb3J0IHR5cGUgVmFsdWVTcGVjID0gYW55O1xuXG5leHBvcnQgdHlwZSBTcGVjID0gT2JqZWN0U3BlYyB8IEFycmF5U3BlYyB8IFZhbHVlU3BlYztcblxuZXhwb3J0IHR5cGUgVGVzdEZ1bmN0aW9uID0gKGRhdGE6IGFueSwgZXhwZWN0OiBhbnksIHNwZWM6IFNwZWMpID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIEZvcm1hdEZ1bmN0aW9uID0gKGRhdGE6IGFueSkgPT4gc3RyaW5nO1xuXG4vKlxuICogUnVuIGRhdGEgZHJpdmUgdGVzdCB3aXRoIHRlc3RzIGlzIG9uZSBvZiB0aGVzZSBmb3JtYXRzOlxuICogWyB7IGxhYmVsOiAob3B0KSA8c3RyaW5nPiwgZGF0YTogPGlucHV0PiwgZXhwZWN0OiAob3B0KSA8ZXhwZWN0ZWQgb3V0cHV0PiB9LCAuLi4gXVxuICogWyBbIDxpbnB1dD4sIDxleHBlY3RlZCBvdXRwdXQ+IF0sIC4uLiBdXG4gKiBbIHNjYWxhciwgLi4uIF1cbiAqXG4gKiBDYWxscyB0ZXN0SXQoZGF0YSwgZXhwZWN0KSBmb3IgZWFjaCB0ZXN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gZGF0YURyaXZlblRlc3QodGVzdHM6IFNwZWNbXSwgdGVzdEl0OiBUZXN0RnVuY3Rpb24sIGZvcm1hdHRlciA9IGZvcm1hdCkge1xuICB2YXIgZGF0YTogYW55O1xuICB2YXIgZXhwZWN0OiBhbnk7XG4gIHZhciBsYWJlbDogc3RyaW5nO1xuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgdGVzdHMubGVuZ3RoOyBpKyspIHtcbiAgICAvLyBOb3QgQXJyYXkgb3IgT2JqZWN0XG4gICAgaWYgKHR5cGVvZiB0ZXN0c1tpXSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIGxhYmVsID0gZm9ybWF0dGVyKHRlc3RzW2ldKTtcbiAgICAgIGRhdGEgPSB0ZXN0c1tpXTtcbiAgICAgIGV4cGVjdCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YSA9IHRlc3RzW2ldLmRhdGE7XG4gICAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRhdGEgPSB0ZXN0c1tpXVswXTtcbiAgICAgIH1cbiAgICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZGF0YSA9IHRlc3RzW2ldO1xuICAgICAgfVxuICAgICAgaWYgKHV0aWwuaXNUeXBlKGRhdGEsICdvYmplY3QnKSAmJiAnZXhwZWN0JyBpbiBkYXRhKSB7XG4gICAgICAgIGRhdGEgPSB1dGlsLmV4dGVuZCh7fSwgZGF0YSk7XG4gICAgICAgIGRlbGV0ZSBkYXRhLmV4cGVjdDtcbiAgICAgIH1cbiAgICAgIGV4cGVjdCA9IHRlc3RzW2ldLmV4cGVjdCB8fCB0ZXN0c1tpXVsxXTtcbiAgICAgIGxhYmVsID0gdGVzdHNbaV0ubGFiZWw7XG4gICAgICBpZiAobGFiZWwgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoZXhwZWN0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBsYWJlbCA9IGZvcm1hdHRlcihkYXRhKSArIFwiID0+IFwiICsgZm9ybWF0dGVyKGV4cGVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFiZWwgPSBmb3JtYXR0ZXIoZGF0YSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBzZXR1cCgoKSA9PiB7XG4gICAgICBsb2dnZXIucmVzZXQoKTtcbiAgICAgIGxvZ2dlci5zaWxlbnQoKTtcbiAgICB9KTtcbiAgICB0ZWFyZG93bigoKSA9PiB7XG4gICAgICBsb2dnZXIucmVzZXQoKTtcbiAgICB9KTtcbiAgICB0ZXN0KGxhYmVsLCB0ZXN0SXQuYmluZCh1bmRlZmluZWQsIGRhdGEsIGV4cGVjdCwgdGVzdHNbaV0pKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBmb3JtYXQobzogYW55KTogc3RyaW5nIHtcbiAgc3dpdGNoICh1dGlsLnR5cGVPZihvKSkge1xuICBjYXNlICdyZWdleHAnOlxuICAgIHJldHVybiBvLnRvU3RyaW5nKCk7XG4gIGRlZmF1bHQ6XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG8pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBGb3JtYXQoeDogYW55KTogc3RyaW5nIHtcbiAgaWYgKHV0aWwuaXNUeXBlKHgsICdhcnJheScpKSB7XG4gICAgcmV0dXJuICdbJyArIHgubWFwKGV4cEZvcm1hdCkuam9pbignLCAnKSArICddJztcbiAgfVxuICBpZiAodXRpbC5pc1R5cGUoeCwgJ29iamVjdCcpKSB7XG4gICAgaWYgKCd0eXBlJyBpbiB4KSB7XG4gICAgICByZXR1cm4gYXN0LmRlY29kZUV4cHJlc3Npb24oeCk7XG4gICAgfVxuICAgIHZhciByZXN1bHQgPSAneyc7XG4gICAgdmFyIHNlcCA9ICcnO1xuICAgIGZvciAodmFyIHByb3AgaW4geCkge1xuICAgICAgaWYgKCF4Lmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgcmVzdWx0ICs9IHNlcCArIGV4cEZvcm1hdCh4W3Byb3BdKTtcbiAgICAgIHNlcCA9ICcsICc7XG4gICAgfVxuICAgIHJlc3VsdCArPSAnfSc7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoeCk7XG59XG4iXX0=
