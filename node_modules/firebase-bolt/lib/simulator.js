"use strict";
/*
 * Firebase Rules test simulator.
 *
 * Copyright 2015 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var chai_1 = require('chai');
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = require('./bolt');
var generate = util.lift(bolt.generate);
var readFile = util.liftArgs(fileIO.readFile);
var MAX_TEST_MS = 60000;
;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
var RulesSuite = (function () {
    function RulesSuite(suiteName, fnSuite) {
        this.suiteName = suiteName;
        this.fnSuite = fnSuite;
        this.debug = false;
        this.users = {};
        this.tests = [];
    }
    RulesSuite.prototype.setDebug = function (debug) {
        if (debug === void 0) { debug = true; }
        this.debug = debug;
        return this;
    };
    RulesSuite.prototype.run = function () {
        var self = this;
        // Run Mocha Test Suite - serialize with any other mocha test suites.
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = generate(util.getProp(readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database])
                    .then(self.onRulesReady.bind(self));
                // Execute initialization and get test definitions (in client code).
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
                // pass
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    };
    RulesSuite.prototype.getInterface = function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    };
    // Called when rules are generated and test database is known.
    RulesSuite.prototype.onRulesReady = function (prereq) {
        var rulesJSON = prereq[0];
        return this.adminClient.put(rest.RULES_LOCATION, rulesJSON);
    };
    RulesSuite.prototype.runTests = function () {
        var p = Promise.resolve();
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    };
    RulesSuite.prototype.test = function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    };
    RulesSuite.prototype.rules = function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    };
    RulesSuite.prototype.database = function (appName, appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appName = appName;
        this.appSecret = appSecret;
        this.adminClient = this.ensureUser('admin');
        this.databaseReady();
    };
    RulesSuite.prototype.uid = function (username) {
        return this.ensureUser(username).uid;
    };
    RulesSuite.prototype.ensureUser = function (username) {
        if (!(username in this.users)) {
            if (username === 'anon') {
                this.users[username] = new rest.Client(this.appName);
            }
            else {
                var tokenInfo = rest.generateUidAuthToken(this.appSecret, { debug: true,
                    admin: username === 'admin' });
                this.users[username] = new rest.Client(this.appName, tokenInfo.token, tokenInfo.uid);
            }
        }
        return this.users[username];
    };
    return RulesSuite;
}());
var RulesTest = (function () {
    function RulesTest(testName, suite, fnTest) {
        this.testName = testName;
        this.suite = suite;
        this.fnTest = fnTest;
        this.steps = [];
        this.failed = false;
    }
    RulesTest.prototype.run = function () {
        var _this = this;
        this.debug(false);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        this.debug(false);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    };
    // Queue a function to be called in sequence after previous step
    // in test is (successfully) completed.
    RulesTest.prototype.queue = function (op, args, fn) {
        if (this.failed) {
            return;
        }
        var argsT = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + argsT.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    };
    RulesTest.prototype.executeQueue = function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    };
    RulesTest.prototype.debug = function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.as = function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        this.queue('as', arguments, function () {
            client.setDebug(_this.suite.debug);
            _this.client = client;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.at = function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.write = function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to write."));
            }
            return _this.client.put(_this.path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.push = function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to push."));
            }
            var path = _this.path;
            if (path.slice(-1)[0] !== '/') {
                path += '/';
            }
            path += rest.generatePushID();
            return _this.client.put(path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.read = function () {
        var _this = this;
        this.queue('read', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to read."));
            }
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.succeeds = function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            chai_1.assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.fails = function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            chai_1.assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.good = function (message) {
        this.log(message + " (Correct)");
    };
    RulesTest.prototype.log = function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    };
    RulesTest.prototype.messageFormat = function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    };
    return RulesTest;
}());
exports.RulesTest = RulesTest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpbXVsYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7R0FnQkc7QUFDSCxxQkFBcUIsTUFBTSxDQUFDLENBQUE7QUFDNUIsSUFBWSxJQUFJLFdBQU0saUJBQWlCLENBQUMsQ0FBQTtBQUN4QyxJQUFZLElBQUksV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUMvQixJQUFZLE1BQU0sV0FBTSxXQUFXLENBQUMsQ0FBQTtBQUNwQyxJQUFZLElBQUksV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUUvQixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN4QyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUU5QyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFhdkIsQ0FBQztBQUVGLG9CQUEyQixTQUFpQixFQUFFLE9BQXNCO0lBQ2xFLElBQUksVUFBVSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMzQyxDQUFDO0FBRmUsa0JBQVUsYUFFekIsQ0FBQTtBQUVEO0lBWUUsb0JBQW1CLFNBQWlCLEVBQ2hCLE9BQXNCO1FBRHZCLGNBQVMsR0FBVCxTQUFTLENBQVE7UUFDaEIsWUFBTyxHQUFQLE9BQU8sQ0FBZTtRQVpsQyxVQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ2QsVUFBSyxHQUFrQyxFQUFFLENBQUM7UUFDMUMsVUFBSyxHQUFnQixFQUFFLENBQUM7SUFVYSxDQUFDO0lBRTlDLDZCQUFRLEdBQVIsVUFBUyxLQUFZO1FBQVoscUJBQVksR0FBWixZQUFZO1FBQ25CLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsd0JBQUcsR0FBSDtRQUNFLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUVoQixxRUFBcUU7UUFDckUsS0FBSyxDQUFDLDRCQUE0QixHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUMxQixVQUFVLENBQUM7Z0JBQ1QsSUFBSSxTQUFTLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBUyxPQUFPO29CQUMxQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO2dCQUNsQyxDQUFDLENBQUMsQ0FBQztnQkFFSCxJQUFJLFFBQVEsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFTLE9BQU87b0JBQ3pDLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDO2dCQUMvQixDQUFDLENBQUMsQ0FBQztnQkFFSCxJQUFJLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFFdkUsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO3FCQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFFdEMsb0VBQW9FO2dCQUNwRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUVsQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNwQixDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxpQkFBaUIsRUFBRTtnQkFDdEIsT0FBTztZQUNULENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGlDQUFZLEdBQVo7UUFDRSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCw4REFBOEQ7SUFDOUQsaUNBQVksR0FBWixVQUFhLE1BQXFCO1FBQ2hDLElBQUksU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsNkJBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUUxQixjQUFjLElBQWtCLEVBQUUsSUFBZTtZQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDZixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3BCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMzQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQseUJBQUksR0FBSixVQUFLLFFBQWdCLEVBQUUsTUFBa0M7UUFDdkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCwwQkFBSyxHQUFMLFVBQU0sU0FBaUI7UUFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFDRCxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVELDZCQUFRLEdBQVIsVUFBUyxPQUFlLEVBQUUsU0FBaUI7UUFDekMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQywwREFBMEQsQ0FBQyxDQUFDO1FBQzlFLENBQUM7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCx3QkFBRyxHQUFILFVBQUksUUFBZ0I7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCwrQkFBVSxHQUFWLFVBQVcsUUFBZ0I7UUFDekIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDdkQsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FDdkMsSUFBSSxDQUFDLFNBQVMsRUFDZCxFQUFFLEtBQUssRUFBRSxJQUFJO29CQUNYLEtBQUssRUFBRSxRQUFRLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2RixDQUFDO1FBQ0gsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFDSCxpQkFBQztBQUFELENBaElBLEFBZ0lDLElBQUE7QUFPRDtJQVFFLG1CQUFvQixRQUFnQixFQUNoQixLQUFpQixFQUNqQixNQUFrQztRQUZsQyxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDakIsV0FBTSxHQUFOLE1BQU0sQ0FBNEI7UUFSOUMsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUNuQixXQUFNLEdBQUcsS0FBSyxDQUFDO0lBT2tDLENBQUM7SUFFMUQsdUJBQUcsR0FBSDtRQUFBLGlCQXNCQztRQXJCQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRWhDLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxCLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7YUFDdkIsSUFBSSxDQUFDO1lBQ0osS0FBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsVUFBQyxLQUFLO1lBQ1gsS0FBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDN0IsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxnRUFBZ0U7SUFDaEUsdUNBQXVDO0lBQ3ZDLHlCQUFLLEdBQUwsVUFBTSxFQUFVLEVBQUUsSUFBb0IsRUFBRSxFQUFzQjtRQUM1RCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNoQixNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBUyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxLQUFLLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUM5QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBQyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELGdDQUFZLEdBQVo7UUFDRSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFFaEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU5QixjQUFjLElBQWtCLEVBQUUsSUFBVTtZQUMxQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDZixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNuQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDM0MsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRCxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELHlCQUFLLEdBQUwsVUFBTSxLQUFlO1FBQXJCLGlCQU9DO1FBTkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFO1lBQzdCLEtBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHNCQUFFLEdBQUYsVUFBRyxRQUFnQjtRQUFuQixpQkFRQztRQVBDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUMxQixNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEMsS0FBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsc0JBQUUsR0FBRixVQUFHLE1BQTBCO1FBQTdCLGlCQU1DO1FBTEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQzFCLEtBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDO1lBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHlCQUFLLEdBQUwsVUFBTSxHQUFRO1FBQWQsaUJBZUM7UUFkQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUU7WUFDN0IsRUFBRSxDQUFDLENBQUMsS0FBSSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDLENBQUM7WUFDOUUsQ0FBQztZQUNELE1BQU0sQ0FBQyxLQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQztpQkFDbkMsSUFBSSxDQUFDO2dCQUNKLEtBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsVUFBQyxLQUFLO2dCQUNYLEtBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixLQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCx3QkFBSSxHQUFKLFVBQUssR0FBUTtRQUFiLGlCQW9CQztRQW5CQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUU7WUFDN0IsRUFBRSxDQUFDLENBQUMsS0FBSSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLENBQUM7WUFDN0UsQ0FBQztZQUNELElBQUksSUFBSSxHQUFHLEtBQUksQ0FBQyxJQUFJLENBQUM7WUFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLElBQUksSUFBSSxHQUFHLENBQUM7WUFDZCxDQUFDO1lBQ0QsSUFBSSxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUM5QixNQUFNLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQztpQkFDOUIsSUFBSSxDQUFDO2dCQUNKLEtBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsVUFBQyxLQUFLO2dCQUNYLEtBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixLQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCx3QkFBSSxHQUFKO1FBQUEsaUJBZUM7UUFkQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUU7WUFDNUIsRUFBRSxDQUFDLENBQUMsS0FBSSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLENBQUM7WUFDN0UsQ0FBQztZQUNELE1BQU0sQ0FBQyxLQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFJLENBQUMsSUFBSSxDQUFDO2lCQUM5QixJQUFJLENBQUM7Z0JBQ0osS0FBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7WUFDckIsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxVQUFDLEtBQUs7Z0JBQ1gsS0FBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7Z0JBQ3BCLEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBQ3pCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELDRCQUFRLEdBQVIsVUFBUyxPQUFlO1FBQXhCLGlCQVNDO1FBUkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsU0FBUyxFQUFFO1lBQ2hDLGFBQU0sQ0FBQyxLQUFJLENBQUMsTUFBTSxLQUFLLElBQUksRUFDcEIsS0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEdBQUcsMEJBQTBCLEdBQUcsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbEYsS0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNuQixLQUFJLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztZQUN4QixNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCx5QkFBSyxHQUFMLFVBQU0sT0FBZTtRQUFyQixpQkFTQztRQVJDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRTtZQUM3QixhQUFNLENBQUMsS0FBSSxDQUFDLE1BQU0sS0FBSyxLQUFLLEVBQ3JCLEtBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxHQUFHLHVCQUF1QixDQUFDLENBQUMsQ0FBQztZQUM5RCxLQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25CLEtBQUksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLHdCQUFJLEdBQVosVUFBYSxPQUFlO1FBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLFlBQVksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyx1QkFBRyxHQUFYLFVBQVksT0FBZTtRQUN6QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDM0MsQ0FBQztJQUNILENBQUM7SUFFRCxpQ0FBYSxHQUFiLFVBQWMsT0FBZTtRQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQztJQUNwRSxDQUFDO0lBQ0gsZ0JBQUM7QUFBRCxDQTNMQSxBQTJMQyxJQUFBO0FBM0xZLGlCQUFTLFlBMkxyQixDQUFBIiwiZmlsZSI6InNpbXVsYXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBGaXJlYmFzZSBSdWxlcyB0ZXN0IHNpbXVsYXRvci5cbiAqXG4gKiBDb3B5cmlnaHQgMjAxNSBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHthc3NlcnR9IGZyb20gJ2NoYWknO1xuaW1wb3J0ICogYXMgcmVzdCBmcm9tICcuL2ZpcmViYXNlLXJlc3QnO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICcuL3V0aWwnO1xuaW1wb3J0ICogYXMgZmlsZUlPIGZyb20gJy4vZmlsZS1pbyc7XG5pbXBvcnQgKiBhcyBib2x0IGZyb20gJy4vYm9sdCc7XG5cbmxldCBnZW5lcmF0ZSA9IHV0aWwubGlmdChib2x0LmdlbmVyYXRlKTtcbmxldCByZWFkRmlsZSA9IHV0aWwubGlmdEFyZ3MoZmlsZUlPLnJlYWRGaWxlKTtcblxudmFyIE1BWF9URVNUX01TID0gNjAwMDA7XG5cbmV4cG9ydCB0eXBlIFN1aXRlRnVuY3Rpb24gPSAoZm46IFRlc3RGdW5jdGlvbikgPT4gdm9pZDtcblxuLy8gSW50ZXJmYWNlIGZvciAndGVzdCcgZnVuY3Rpb24gcGFzc2VkIGJhY2sgdG8gcnVsZXNTdWl0ZSBjYWxsYmFjay5cbi8vIHRlc3QgaXMgYSBmdW5jdGlvbiBhcyB3ZWxsIGFzIGEgbmFtZXNwYWNlIGZvciBzb21lIHN0YXRpYyBtZXRob2RzXG4vLyBhbmQgY29uc3RhbnRzLlxuZXhwb3J0IGludGVyZmFjZSBUZXN0RnVuY3Rpb24ge1xuICAobmFtZTogc3RyaW5nLCBmblRlc3Q6IChydWxlczogUnVsZXNUZXN0KSA9PiB2b2lkKTogdm9pZDtcbiAgcnVsZXM6IChwYXRoOiBzdHJpbmcpID0+IHZvaWQ7XG4gIGRhdGFiYXNlOiAoYXBwTmFtZTogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZykgPT4gdm9pZDtcbiAgdWlkOiAodXNlcm5hbWU6IHN0cmluZykgPT4gc3RyaW5nO1xuICBUSU1FU1RBTVA6IE9iamVjdDtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBydWxlc1N1aXRlKHN1aXRlTmFtZTogc3RyaW5nLCBmblN1aXRlOiBTdWl0ZUZ1bmN0aW9uKSB7XG4gIG5ldyBSdWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkucnVuKCk7XG59XG5cbmNsYXNzIFJ1bGVzU3VpdGUge1xuICBwdWJsaWMgIGRlYnVnID0gZmFsc2U7XG4gIHByaXZhdGUgdXNlcnMgPSA8e1tuYW1lOiBzdHJpbmddOiByZXN0LkNsaWVudH0+e307XG4gIHByaXZhdGUgdGVzdHMgPSA8UnVsZXNUZXN0W10+W107XG4gIHByaXZhdGUgcnVsZXNQYXRoOiBzdHJpbmc7XG4gIHByaXZhdGUgcnVsZXNQYXRoUmVzb2x2ZTogKHBhdGg6IHN0cmluZykgPT4gdm9pZDtcbiAgcHJpdmF0ZSBkYXRhYmFzZVJlYWR5OiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIHJlYWR5OiBQcm9taXNlPGFueT47XG4gIHByaXZhdGUgYWRtaW5DbGllbnQ6IHJlc3QuQ2xpZW50O1xuICBwcml2YXRlIGFwcE5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSBhcHBTZWNyZXQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgc3VpdGVOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgIHByaXZhdGUgZm5TdWl0ZTogU3VpdGVGdW5jdGlvbikge31cblxuICBzZXREZWJ1ZyhkZWJ1ZyA9IHRydWUpIHtcbiAgICB0aGlzLmRlYnVnID0gZGVidWc7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBydW4oKSB7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgLy8gUnVuIE1vY2hhIFRlc3QgU3VpdGUgLSBzZXJpYWxpemUgd2l0aCBhbnkgb3RoZXIgbW9jaGEgdGVzdCBzdWl0ZXMuXG4gICAgc3VpdGUoXCJGaXJlYmFzZSBSdWxlcyBTaW11bGF0b3I6IFwiICsgc2VsZi5zdWl0ZU5hbWUsIGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy50aW1lb3V0KE1BWF9URVNUX01TKTtcbiAgICAgIHN1aXRlU2V0dXAoZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBydWxlc1BhdGggPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XG4gICAgICAgICAgc2VsZi5ydWxlc1BhdGhSZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGRhdGFiYXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkge1xuICAgICAgICAgIHNlbGYuZGF0YWJhc2VSZWFkeSA9IHJlc29sdmU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHZhciBydWxlc0pTT04gPSBnZW5lcmF0ZSh1dGlsLmdldFByb3AocmVhZEZpbGUocnVsZXNQYXRoKSwgJ2NvbnRlbnQnKSk7XG5cbiAgICAgICAgc2VsZi5yZWFkeSA9IFByb21pc2UuYWxsKFtydWxlc0pTT04sIGRhdGFiYXNlXSlcbiAgICAgICAgICAudGhlbihzZWxmLm9uUnVsZXNSZWFkeS5iaW5kKHNlbGYpKTtcblxuICAgICAgICAvLyBFeGVjdXRlIGluaXRpYWxpemF0aW9uIGFuZCBnZXQgdGVzdCBkZWZpbml0aW9ucyAoaW4gY2xpZW50IGNvZGUpLlxuICAgICAgICBzZWxmLmZuU3VpdGUoc2VsZi5nZXRJbnRlcmZhY2UoKSk7XG5cbiAgICAgICAgcmV0dXJuIHNlbGYucmVhZHk7XG4gICAgICB9KTtcblxuICAgICAgdGVzdChcIkluaXRpYWxpemF0aW9uLlwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgLy8gcGFzc1xuICAgICAgfSk7XG5cbiAgICAgIHRlc3QoXCJSdWxlcyB0ZXN0LlwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHNlbGYucnVuVGVzdHMoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0SW50ZXJmYWNlKCkge1xuICAgIHZhciB0ZXN0ID0gdGhpcy50ZXN0LmJpbmQodGhpcyk7XG4gICAgdGVzdC5ydWxlcyA9IHRoaXMucnVsZXMuYmluZCh0aGlzKTtcbiAgICB0ZXN0LmRhdGFiYXNlID0gdGhpcy5kYXRhYmFzZS5iaW5kKHRoaXMpO1xuICAgIHRlc3QudWlkID0gdGhpcy51aWQuYmluZCh0aGlzKTtcbiAgICB0ZXN0LlRJTUVTVEFNUCA9IHJlc3QuVElNRVNUQU1QO1xuICAgIHJldHVybiB0ZXN0O1xuICB9XG5cbiAgLy8gQ2FsbGVkIHdoZW4gcnVsZXMgYXJlIGdlbmVyYXRlZCBhbmQgdGVzdCBkYXRhYmFzZSBpcyBrbm93bi5cbiAgb25SdWxlc1JlYWR5KHByZXJlcTogW09iamVjdCwgYW55XSkge1xuICAgIGxldCBydWxlc0pTT04gPSBwcmVyZXFbMF07XG4gICAgcmV0dXJuIHRoaXMuYWRtaW5DbGllbnQucHV0KHJlc3QuUlVMRVNfTE9DQVRJT04sIHJ1bGVzSlNPTik7XG4gIH1cblxuICBydW5UZXN0cygpIHtcbiAgICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2OiBQcm9taXNlPGFueT4sIHRlc3Q6IFJ1bGVzVGVzdCk6IFByb21pc2U8YW55PiB7XG4gICAgICByZXR1cm4gcHJldi50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGVzdC5ydW4oKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgcCA9IG5leHQocCwgdGhpcy50ZXN0c1tpXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICB0ZXN0KHRlc3ROYW1lOiBzdHJpbmcsIGZuVGVzdDogKHJ1bGVzOiBSdWxlc1Rlc3QpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLnRlc3RzLnB1c2gobmV3IFJ1bGVzVGVzdCh0ZXN0TmFtZSwgdGhpcywgZm5UZXN0KSk7XG4gIH1cblxuICBydWxlcyhydWxlc1BhdGg6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLnJ1bGVzUGF0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5ydWxlcyBmdW5jdGlvbi5cIik7XG4gICAgfVxuICAgIHRoaXMucnVsZXNQYXRoID0gcnVsZXNQYXRoO1xuICAgIHRoaXMucnVsZXNQYXRoUmVzb2x2ZSh1dGlsLmVuc3VyZUV4dGVuc2lvbihydWxlc1BhdGgsIGJvbHQuRklMRV9FWFRFTlNJT04pKTtcbiAgfVxuXG4gIGRhdGFiYXNlKGFwcE5hbWU6IHN0cmluZywgYXBwU2VjcmV0OiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5hZG1pbkNsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5kYXRhYmFzZSBmdW5jdGlvbi5cIik7XG4gICAgfVxuICAgIHRoaXMuYXBwTmFtZSA9IGFwcE5hbWU7XG4gICAgdGhpcy5hcHBTZWNyZXQgPSBhcHBTZWNyZXQ7XG4gICAgdGhpcy5hZG1pbkNsaWVudCA9IHRoaXMuZW5zdXJlVXNlcignYWRtaW4nKTtcbiAgICB0aGlzLmRhdGFiYXNlUmVhZHkoKTtcbiAgfVxuXG4gIHVpZCh1c2VybmFtZTogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5lbnN1cmVVc2VyKHVzZXJuYW1lKS51aWQ7XG4gIH1cblxuICBlbnN1cmVVc2VyKHVzZXJuYW1lOiBzdHJpbmcpOiByZXN0LkNsaWVudCB7XG4gICAgaWYgKCEodXNlcm5hbWUgaW4gdGhpcy51c2VycykpIHtcbiAgICAgIGlmICh1c2VybmFtZSA9PT0gJ2Fub24nKSB7XG4gICAgICAgIHRoaXMudXNlcnNbdXNlcm5hbWVdID0gbmV3IHJlc3QuQ2xpZW50KHRoaXMuYXBwTmFtZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgdG9rZW5JbmZvID0gcmVzdC5nZW5lcmF0ZVVpZEF1dGhUb2tlbihcbiAgICAgICAgICB0aGlzLmFwcFNlY3JldCxcbiAgICAgICAgICB7IGRlYnVnOiB0cnVlLFxuICAgICAgICAgICAgYWRtaW46IHVzZXJuYW1lID09PSAnYWRtaW4nIH0pO1xuICAgICAgICB0aGlzLnVzZXJzW3VzZXJuYW1lXSA9IG5ldyByZXN0LkNsaWVudCh0aGlzLmFwcE5hbWUsIHRva2VuSW5mby50b2tlbiwgdG9rZW5JbmZvLnVpZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudXNlcnNbdXNlcm5hbWVdO1xuICB9XG59XG5cbmludGVyZmFjZSBTdGVwIHtcbiAgbGFiZWw6IHN0cmluZztcbiAgZm46ICgpID0+IFByb21pc2U8YW55Pjtcbn1cblxuZXhwb3J0IGNsYXNzIFJ1bGVzVGVzdCB7XG4gIHByaXZhdGUgbGFzdEVycm9yOiBzdHJpbmc7XG4gIHByaXZhdGUgc3RlcHM6IFN0ZXBbXSA9IFtdO1xuICBwcml2YXRlIGZhaWxlZCA9IGZhbHNlO1xuICBwcml2YXRlIHBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBjbGllbnQ6IHJlc3QuQ2xpZW50O1xuICBwcml2YXRlIHN0YXR1czogYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRlc3ROYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgIHByaXZhdGUgc3VpdGU6IFJ1bGVzU3VpdGUsXG4gICAgICAgICAgICAgIHByaXZhdGUgZm5UZXN0OiAocnVsZXM6IFJ1bGVzVGVzdCkgPT4gdm9pZCkge31cblxuICBydW4oKSB7XG4gICAgdGhpcy5kZWJ1ZyhmYWxzZSk7XG4gICAgdGhpcy5hcygnYWRtaW4nKTtcbiAgICB0aGlzLmF0KCcvJyk7XG4gICAgdGhpcy53cml0ZShudWxsKTtcbiAgICB0aGlzLnN1Y2NlZWRzKFwiaW5pdGlhbGl6YXRpb25cIik7XG5cbiAgICB0aGlzLmF0KHVuZGVmaW5lZCk7XG4gICAgdGhpcy5hcygnYW5vbicpO1xuXG4gICAgdGhpcy5mblRlc3QodGhpcyk7XG5cbiAgICB0aGlzLmRlYnVnKGZhbHNlKTtcblxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVRdWV1ZSgpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMubG9nKFwiRmluaXNoZWRcIik7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICB0aGlzLmxvZyhcIkZhaWxlZDogXCIgKyBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfSk7XG4gIH1cblxuICAvLyBRdWV1ZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpbiBzZXF1ZW5jZSBhZnRlciBwcmV2aW91cyBzdGVwXG4gIC8vIGluIHRlc3QgaXMgKHN1Y2Nlc3NmdWxseSkgY29tcGxldGVkLlxuICBxdWV1ZShvcDogc3RyaW5nLCBhcmdzOiBBcnJheUxpa2U8YW55PiwgZm46ICgpID0+IFByb21pc2U8YW55Pikge1xuICAgIGlmICh0aGlzLmZhaWxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgYXJnc1QgPSB1dGlsLmNvcHlBcnJheShhcmdzKS5tYXAoZnVuY3Rpb24oeCkge1xuICAgICAgcmV0dXJuIHV0aWwucHJldHR5SlNPTih4KTtcbiAgICB9KTtcbiAgICB2YXIgbGFiZWwgPSBvcCArICcoJyArIGFyZ3NULmpvaW4oJywgJykgKyAnKSc7XG4gICAgdGhpcy5zdGVwcy5wdXNoKHtsYWJlbDogbGFiZWwsIGZuOiBmbn0pO1xuICB9XG5cbiAgZXhlY3V0ZVF1ZXVlKCkge1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHRoaXMubG9nKFwiRXhlY3V0aW5nIChcIiArIHRoaXMuc3RlcHMubGVuZ3RoICsgXCIgc3RlcHMpXCIpO1xuICAgIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xuXG4gICAgZnVuY3Rpb24gbmV4dChwcmV2OiBQcm9taXNlPGFueT4sIHN0ZXA6IFN0ZXApOiBQcm9taXNlPGFueT4ge1xuICAgICAgcmV0dXJuIHByZXYudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgc2VsZi5sb2coc3RlcC5sYWJlbCk7XG4gICAgICAgIHJldHVybiBzdGVwLmZuKCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuc3RlcHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHAgPSBuZXh0KHAsIHRoaXMuc3RlcHNbaV0pO1xuICAgIH1cblxuICAgIHJldHVybiBwO1xuICB9XG5cbiAgZGVidWcoZGVidWc/OiBib29sZWFuKTogUnVsZXNUZXN0IHtcbiAgICB0aGlzLnN1aXRlLnNldERlYnVnKGRlYnVnKTtcbiAgICB0aGlzLnF1ZXVlKCdkZWJ1ZycsIGFyZ3VtZW50cywgKCkgPT4ge1xuICAgICAgdGhpcy5zdWl0ZS5zZXREZWJ1ZyhkZWJ1Zyk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhcyh1c2VybmFtZTogc3RyaW5nKTogUnVsZXNUZXN0IHtcbiAgICB2YXIgY2xpZW50ID0gdGhpcy5zdWl0ZS5lbnN1cmVVc2VyKHVzZXJuYW1lKTtcbiAgICB0aGlzLnF1ZXVlKCdhcycsIGFyZ3VtZW50cywgKCkgPT4ge1xuICAgICAgY2xpZW50LnNldERlYnVnKHRoaXMuc3VpdGUuZGVidWcpO1xuICAgICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhdChvcFBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCk6IFJ1bGVzVGVzdCB7XG4gICAgdGhpcy5xdWV1ZSgnYXQnLCBhcmd1bWVudHMsICgpID0+IHtcbiAgICAgIHRoaXMucGF0aCA9IG9wUGF0aDtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHdyaXRlKG9iajogYW55KTogUnVsZXNUZXN0IHtcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMucGF0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJVc2UgYXQoKSBmdW5jdGlvbiB0byBzZXQgcGF0aCB0byB3cml0ZS5cIikpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LnB1dCh0aGlzLnBhdGgsIG9iailcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdXNoKG9iajogYW55KTogUnVsZXNUZXN0IHtcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMucGF0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJVc2UgYXQoKSBmdW5jdGlvbiB0byBzZXQgcGF0aCB0byBwdXNoLlwiKSk7XG4gICAgICB9XG4gICAgICBsZXQgcGF0aCA9IHRoaXMucGF0aDtcbiAgICAgIGlmIChwYXRoLnNsaWNlKC0xKVswXSAhPT0gJy8nKSB7XG4gICAgICAgIHBhdGggKz0gJy8nO1xuICAgICAgfVxuICAgICAgcGF0aCArPSByZXN0LmdlbmVyYXRlUHVzaElEKCk7XG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQucHV0KHBhdGgsIG9iailcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICByZWFkKCk6IFJ1bGVzVGVzdCB7XG4gICAgdGhpcy5xdWV1ZSgncmVhZCcsIGFyZ3VtZW50cywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMucGF0aCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJVc2UgYXQoKSBmdW5jdGlvbiB0byBzZXQgcGF0aCB0byByZWFkLlwiKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQuZ2V0KHRoaXMucGF0aClcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzdWNjZWVkcyhtZXNzYWdlOiBzdHJpbmcpOiBSdWxlc1Rlc3Qge1xuICAgIHRoaXMucXVldWUoJ3N1Y2NlZWRzJywgYXJndW1lbnRzLCAoKSA9PiB7XG4gICAgICBhc3NlcnQodGhpcy5zdGF0dXMgPT09IHRydWUsXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgc3VjY2VlZClcXG5cIiArIHRoaXMubGFzdEVycm9yKSk7XG4gICAgICB0aGlzLmdvb2QobWVzc2FnZSk7XG4gICAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGZhaWxzKG1lc3NhZ2U6IHN0cmluZyk6IFJ1bGVzVGVzdCB7XG4gICAgdGhpcy5xdWV1ZSgnZmFpbHMnLCBhcmd1bWVudHMsICgpID0+IHtcbiAgICAgIGFzc2VydCh0aGlzLnN0YXR1cyA9PT0gZmFsc2UsXG4gICAgICAgICAgICAgdGhpcy5tZXNzYWdlRm9ybWF0KG1lc3NhZ2UgKyBcIiAoc2hvdWxkIGhhdmUgZmFpbGVkKVwiKSk7XG4gICAgICB0aGlzLmdvb2QobWVzc2FnZSk7XG4gICAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHByaXZhdGUgZ29vZChtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmxvZyhtZXNzYWdlICsgXCIgKENvcnJlY3QpXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2cobWVzc2FnZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc3VpdGUuZGVidWcpIHtcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMubWVzc2FnZUZvcm1hdChtZXNzYWdlKSk7XG4gICAgfVxuICB9XG5cbiAgbWVzc2FnZUZvcm1hdChtZXNzYWdlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnN1aXRlLnN1aXRlTmFtZSArIFwiLlwiICsgdGhpcy50ZXN0TmFtZSArIFwiIFwiICsgbWVzc2FnZTtcbiAgfVxufVxuIl19
